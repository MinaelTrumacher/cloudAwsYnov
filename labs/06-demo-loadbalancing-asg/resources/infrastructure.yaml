AWSTemplateFormatVersion: '2010-09-09'
Description: 'D√©monstration Application Load Balancer avec Auto Scaling Group'

Parameters:
  InstanceType:
    Type: String
    Default: t3.micro
    Description: Type d'instance EC2 pour les serveurs web
    AllowedValues:
      - t3.micro
      - t3.small
      - t3.medium

  KeyPairName:
    Type: String
    Default: ''
    Description: 'Nom de la paire de cl√©s EC2 (optionnel pour cette d√©mo)'

Resources:
  # VPC et r√©seau
  DemoVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: Demo-ALB-ASG-VPC
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
        - Key: project
          Value: demo-loadbalancing-asg
        - Key: environment
          Value: development
        - Key: managed-by
          Value: cloudformation

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: Demo-ALB-ASG-IGW
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
        - Key: project
          Value: demo-loadbalancing-asg
        - Key: environment
          Value: development
        - Key: managed-by
          Value: cloudformation

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref DemoVPC
      InternetGatewayId: !Ref InternetGateway

  # Subnets publics dans 3 AZ diff√©rentes
  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref DemoVPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Demo-Public-Subnet-1
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
        - Key: project
          Value: demo-loadbalancing-asg
        - Key: environment
          Value: development
        - Key: managed-by
          Value: cloudformation

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref DemoVPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Demo-Public-Subnet-2
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
        - Key: project
          Value: demo-loadbalancing-asg
        - Key: environment
          Value: development
        - Key: managed-by
          Value: cloudformation

  PublicSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref DemoVPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [2, !GetAZs '']
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: Demo-Public-Subnet-3
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
        - Key: project
          Value: demo-loadbalancing-asg
        - Key: environment
          Value: development
        - Key: managed-by
          Value: cloudformation

  # Table de routage publique
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref DemoVPC
      Tags:
        - Key: Name
          Value: Demo-Public-Route-Table
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
        - Key: project
          Value: demo-loadbalancing-asg
        - Key: environment
          Value: development
        - Key: managed-by
          Value: cloudformation

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  # Association des subnets √† la table de routage
  PublicSubnetRouteTableAssociation1:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetRouteTableAssociation2:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  PublicSubnetRouteTableAssociation3:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet3
      RouteTableId: !Ref PublicRouteTable

  # Security Group pour les instances web
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group pour les serveurs web de la demo
      VpcId: !Ref DemoVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
          Description: HTTP depuis le Load Balancer
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
          Description: SSH pour administration (optionnel)
      Tags:
        - Key: Name
          Value: Demo-WebServer-SG
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
        - Key: project
          Value: demo-loadbalancing-asg
        - Key: environment
          Value: development
        - Key: managed-by
          Value: cloudformation

  # Security Group pour le Load Balancer
  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group pour Application Load Balancer
      VpcId: !Ref DemoVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
          Description: HTTP depuis Internet
      Tags:
        - Key: Name
          Value: Demo-LoadBalancer-SG
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
        - Key: project
          Value: demo-loadbalancing-asg
        - Key: environment
          Value: development
        - Key: managed-by
          Value: cloudformation

  # R√¥le IAM pour les instances EC2
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Tags:
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
        - Key: project
          Value: demo-loadbalancing-asg
        - Key: environment
          Value: development
        - Key: managed-by
          Value: cloudformation

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref EC2Role

  # Launch Template pour l'Auto Scaling Group
  LaunchTemplate:
    Type: AWS::EC2::LaunchTemplate
    Properties:
      LaunchTemplateName: Demo-WebServer-LaunchTemplate
      LaunchTemplateData:
        ImageId: !Sub '{{resolve:ssm:/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2}}'
        InstanceType: !Ref InstanceType
        IamInstanceProfile:
          Arn: !GetAtt EC2InstanceProfile.Arn
        SecurityGroupIds:
          - !Ref WebServerSecurityGroup
        UserData:
          Fn::Base64: !Sub |
            #!/bin/bash
            yum update -y
            yum install -y httpd amazon-ssm-agent
            
            # Installer EPEL pour avoir acc√®s √† stress
            amazon-linux-extras install epel -y
            yum install -y stress
            
            # D√©marrer et activer les services
            systemctl start httpd
            systemctl enable httpd
            systemctl start amazon-ssm-agent
            systemctl enable amazon-ssm-agent
            
            # Obtenir les m√©tadonn√©es de l'instance
            INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
            AZ=$(curl -s http://169.254.169.254/latest/meta-data/placement/availability-zone)
            REGION=$(curl -s http://169.254.169.254/latest/meta-data/placement/region)
            
            # Cr√©er la page web simple
            cat > /var/www/html/index.html << EOF
            <!DOCTYPE html>
            <html>
            <head>
                <title>Serveur Web - D√©mo Load Balancer</title>
                <style>
                    body { 
                        font-family: Arial, sans-serif; 
                        margin: 40px; 
                        background-color: #f0f8ff;
                        text-align: center;
                    }
                    .container { 
                        max-width: 600px; 
                        margin: 0 auto; 
                        padding: 20px; 
                        background-color: white; 
                        border-radius: 10px; 
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    }
                    .server-info { 
                        background-color: #e6f3ff; 
                        padding: 15px; 
                        border-radius: 5px; 
                        margin: 20px 0;
                    }
                    .highlight { color: #0066cc; font-weight: bold; }
                    .timestamp { color: #666; font-size: 0.9em; }
                </style>
            </head>
            <body>
                <div class="container">
                    <h1>üöÄ D√©monstration Load Balancer AWS</h1>
                    <div class="server-info">
                        <h2>Informations du serveur</h2>
                        <p><strong>Nom du serveur:</strong> <span class="highlight">$INSTANCE_ID</span></p>
                        <p><strong>Zone de disponibilit√©:</strong> <span class="highlight">$AZ</span></p>
                        <p><strong>R√©gion:</strong> <span class="highlight">$REGION</span></p>
                    </div>
                    <p class="timestamp">Page g√©n√©r√©e le: $(date)</p>
                    <p>Rafra√Æchissez cette page pour voir la r√©partition de charge entre les serveurs!</p>
                </div>
            </body>
            </html>
            EOF
            
            # Cr√©er le script de simulation de charge
            cat > /home/ec2-user/simulate-load.sh << 'EOF'
            #!/bin/bash
            echo "üî• D√©marrage de la simulation de charge CPU..."
            echo "Cette simulation va consommer 80% du CPU pendant 10 minutes"
            echo "Cela devrait d√©clencher l'auto-scaling si configur√© correctement"
            
            # Lancer stress en arri√®re-plan pour 10 minutes
            stress --cpu 1 --timeout 600s &
            STRESS_PID=$!
            
            echo "Simulation de charge d√©marr√©e (PID: $STRESS_PID)"
            echo "Pour arr√™ter la simulation: kill $STRESS_PID"
            echo "La simulation s'arr√™tera automatiquement dans 10 minutes"
            EOF
            
            chmod +x /home/ec2-user/simulate-load.sh
            chown ec2-user:ec2-user /home/ec2-user/simulate-load.sh
      TagSpecifications:
        - ResourceType: launch-template
          Tags:
            - Key: Name
              Value: Demo-WebServer-LaunchTemplate
            - Key: git-repository
              Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
            - Key: project
              Value: demo-loadbalancing-asg
            - Key: environment
              Value: development
            - Key: managed-by
              Value: cloudformation

  # Application Load Balancer
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: Demo-Application-LoadBalancer
      Scheme: internet-facing
      Type: application
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
        - !Ref PublicSubnet3
      SecurityGroups:
        - !Ref LoadBalancerSecurityGroup
      Tags:
        - Key: Name
          Value: Demo-Application-LoadBalancer
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
        - Key: project
          Value: demo-loadbalancing-asg
        - Key: environment
          Value: development
        - Key: managed-by
          Value: cloudformation

  # Target Group pour le Load Balancer
  TargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: Demo-WebServers-TG
      Port: 80
      Protocol: HTTP
      VpcId: !Ref DemoVPC
      HealthCheckPath: /
      HealthCheckProtocol: HTTP
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      UnhealthyThresholdCount: 3
      Tags:
        - Key: Name
          Value: Demo-WebServers-TargetGroup
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
        - Key: project
          Value: demo-loadbalancing-asg
        - Key: environment
          Value: development
        - Key: managed-by
          Value: cloudformation

  # Listener pour le Load Balancer
  LoadBalancerListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref TargetGroup
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP

  # Auto Scaling Group
  AutoScalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AutoScalingGroupName: Demo-WebServers-ASG
      LaunchTemplate:
        LaunchTemplateId: !Ref LaunchTemplate
        Version: !GetAtt LaunchTemplate.LatestVersionNumber
      MinSize: 3
      MaxSize: 6
      DesiredCapacity: 3
      VPCZoneIdentifier:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
        - !Ref PublicSubnet3
      TargetGroupARNs:
        - !Ref TargetGroup
      HealthCheckType: ELB
      HealthCheckGracePeriod: 300
      Tags:
        - Key: Name
          Value: Demo-WebServer-ASG-Instance
          PropagateAtLaunch: true
        - Key: git-repository
          Value: https://github.com/soraskills/develop-for-the-cloud-labs.git
          PropagateAtLaunch: true
        - Key: project
          Value: demo-loadbalancing-asg
          PropagateAtLaunch: true
        - Key: environment
          Value: development
          PropagateAtLaunch: true
        - Key: managed-by
          Value: cloudformation
          PropagateAtLaunch: true

  # Politique de scaling bas√©e sur le CPU
  ScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref AutoScalingGroup
      Cooldown: 300
      ScalingAdjustment: 1
      PolicyType: SimpleScaling

  ScaleDownPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref AutoScalingGroup
      Cooldown: 300
      ScalingAdjustment: -1
      PolicyType: SimpleScaling

  # Alarmes CloudWatch pour d√©clencher l'auto-scaling
  HighCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: Demo-High-CPU-Utilization
      AlarmDescription: D√©clenche le scale-up quand le CPU d√©passe 70%
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 70
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref AutoScalingGroup
      AlarmActions:
        - !Ref ScaleUpPolicy

  LowCPUAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: Demo-Low-CPU-Utilization
      AlarmDescription: D√©clenche le scale-down quand le CPU descend sous 25%
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Statistic: Average
      Period: 300
      EvaluationPeriods: 2
      Threshold: 25
      ComparisonOperator: LessThanThreshold
      Dimensions:
        - Name: AutoScalingGroupName
          Value: !Ref AutoScalingGroup
      AlarmActions:
        - !Ref ScaleDownPolicy

Outputs:
  LoadBalancerURL:
    Description: URL de l'Application Load Balancer
    Value: !Sub 'http://${ApplicationLoadBalancer.DNSName}'
    Export:
      Name: !Sub '${AWS::StackName}-LoadBalancerURL'

  LoadBalancerDNS:
    Description: Nom DNS de l'Application Load Balancer
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-LoadBalancerDNS'

  AutoScalingGroupName:
    Description: Nom de l'Auto Scaling Group
    Value: !Ref AutoScalingGroup
    Export:
      Name: !Sub '${AWS::StackName}-AutoScalingGroupName'

  VPCId:
    Description: ID du VPC cr√©√©
    Value: !Ref DemoVPC
    Export:
      Name: !Sub '${AWS::StackName}-VPCId'